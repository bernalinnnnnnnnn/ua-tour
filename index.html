<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>UA360X</title>
  <link rel="stylesheet" href="index2.css">
  <style>
    /* Override styles for logo positioning */
    .viewer .overlay-logo {
      position: absolute;
      top: 20px;
      object-fit: contain;
      opacity: 0.85;
      pointer-events: none;
      z-index: 10;
      filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.6));
      transition: opacity 0.3s ease;
    }

    .viewer .overlay-logo.left {
      left: 20px;
      width: 120px;        /* Logo size - adjust this */
      height: 120px;
    }

    .viewer .overlay-logo.right {
      right: 20px;
      width: 180px;        /* Map size - adjust this */
      height: 180px;
    }

    .viewer iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: none;
      z-index: 1;
    }

    @media (max-width: 768px) {
      .viewer .overlay-logo {
        top: 15px;
      }

      .viewer .overlay-logo.left {
        left: 15px;
        width: 80px;       /* Logo size for tablet */
        height: 80px;
      }

      .viewer .overlay-logo.right {
        right: 15px;
        width: 120px;      /* Map size for tablet */
        height: 120px;
      }
    }

    @media (max-width: 480px) {
      .viewer .overlay-logo {
        top: 10px;
      }

      .viewer .overlay-logo.left {
        left: 10px;
        width: 60px;       /* Logo size for mobile */
        height: 60px;
      }

      .viewer .overlay-logo.right {
        right: 10px;
        width: 90px;       /* Map size for mobile */
        height: 90px;
      }
    }
  </style>
</head>

<body>
  <header>
    <button id="menuBtn">â˜°</button>
    <h1>University of Abra</h1>
  </header>

  <div class="map-container" id="mapContainer">
    <img src="assets/ua2.jpg" alt="University of Abra Map" id="campusMap">
  </div>

  <div class="viewer" id="viewer">
    <iframe id="tourFrame" title="Campus Tour Viewer" src=""
      allow="accelerometer; gyroscope; xr-spatial-tracking"></iframe>
    <img id="leftLogo" src="assets/logos/logo.png" alt="UA Logo" class="overlay-logo left">
    <img id="rightLogo" src="assets/maps/default.png" alt="Map Overlay" class="overlay-logo right">
    <button id="backBtn" class="back-btn" title="Back to home">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
        <polyline points="9 22 9 12 15 12 15 22"></polyline>
      </svg>
    </button>
  </div>

  <div class="sidebar" id="sidebar">
    <iframe id="indexFrame" src="tours.html"></iframe>
  </div>

  <div class="overlay" id="overlay"></div>

  <script>
    const pins = [
      { name: "College of Teacher Education", link: "https://kuula.co/share/hsps4/collection/7DxGN?logo=-1&info=0&fs=0&vr=0&sd=1&thumbs=-1&keys=0", top: "80%", left: "40.5%" },
      { name: "Information and Communication Technology Center", link: "https://kuula.co/share/hwCgs/collection/7D308?logo=-1&info=0&fs=0&vr=0&sd=1&thumbs=-1&keys=0", top: "79%", left: "38.9%" },
      { name: "Asist Training and Development Center", link: "https://kuula.co/share/h34Rl/collection/7DSkq?logo=-1&info=0&fs=0&vr=0&sd=1&thumbs=-1&keys=0", top: "72%", left: "41%" },
      { name: "Guidance and Counseling Office", link: "https://kuula.co/share/h3rLj/collection/7H4Mc?logo=-1&info=0&fs=0&vr=0&sd=1&thumbs=-1&keys=0", top: "86%", left: "40.8%" },
      { name: "Gymnasium", link: "https://kuula.co/share/collection/7H4MG?logo=-1&info=0&fs=0&vr=0&sd=1&thumbs=-1&keys=0", top: "68%", left: "33.5%" },
      { name: "Central Agricultural Laboratory", link: "https://kuula.co/share/h3BQ3/collection/7H4HH?logo=-1&info=0&fs=0&vr=0&sd=1&thumbs=-1&keys=0", top: "67%", left: "40%" },
      { name: "Asist Laboratory High School", link: "https://kuula.co/share/h3BdG/collection/7H4DT?logo=-1&info=0&fs=0&vr=0&sd=1&thumbs=-1&keys=0", top: "33%", left: "24%" },
      { name: "Natural Sciences Central Laboratory", link: "https://kuula.co/share/hRVMg/collection/7H4qw?logo=-1&info=0&fs=0&vr=0&sd=1&thumbs=-1&keys=0", top: "74.5%", left: "40%" },
      { name: "Sciences Building", link: "https://kuula.co/share/h3w95/collection/7Dtgc?logo=-1&info=0&fs=0&vr=0&sd=1&thumbs=-1&keys=0", top: "75%", left: "38%" },
      { name: "College of Agriculture", link: "https://kuula.co/share/h3TnQ/collection/7DrsL?logo=-1&info=0&fs=0&vr=0&sd=1&thumbs=-1&keys=0", top: "70.5%", left: "42.5%" },
      { name: "Executive House", link: "https://kuula.co/share/h377s/collection/7DSqc?logo=-1&info=0&fs=0&vr=0&sd=1&thumbs=-1&keys=0", top: "56%", left: "31.8%" },
      { name: "Guest House", link: "https://kuula.co/share/hRj4M/collection/7DSkB?logo=-1&info=0&fs=0&vr=0&sd=1&thumbs=-1&keys=0", top: "70%", left: "40.8%" },
      { name: "Student Center", link: "https://kuula.co/share/h20kM/collection/7DWfD?logo=-1&info=0&fs=0&vr=0&sd=1&thumbs=-1&keys=0", top: "82%", left: "39.5%" },
      { name: "Forestry Laboratory Center", link: "https://kuula.co/share/collection/7D3R5?logo=-1&info=0&fs=0&vr=0&sd=1&thumbs=-1&keys=0", top: "76%", left: "43.5%" },
      { name: "AFTIICC", link: "https://kuula.co/share/hWFYM/collection/7HmCC?logo=-1&info=0&fs=0&vr=0&sd=1&thumbs=-1&keys=0", top: "50%", left: "31%" },
      { name: "Research and Extension", link: "https://kuula.co/share/hymVL/collection/7Hm6F?logo=-1&info=0&fs=0&vr=0&sd=1&thumbs=-1&keys=0", top: "50%", left: "28.8%" },
      { name: "HEAS Building", link: "https://kuula.co/share/hWPXC/collection/7HmPt?logo=-1&info=0&fs=0&vr=0&sd=1&thumbs=-1&keys=0", top: "63%", left: "32%" },
      { name: "FFP Hall", link: "https://kuula.co/share/hWLKP/collection/7HL6Z?logo=-1&info=0&fs=0&vr=0&sd=1&thumbs=-1&keys=0", top: "40%", left: "24%" },
      { name: "Administration Building", link: "https://kuula.co/share/hWhvt/collection/7HLDj?logo=-1&info=0&fs=0&vr=0&sd=1&thumbs=-1&keys=0", top: "37%", left: "25%" },
      { name: "Village Level Processing Unit", link: "https://kuula.co/share/hW3f4/collection/7HLvX?logo=-1&info=0&fs=0&vr=0&sd=1&thumbs=-1&keys=0", top: "78%", left: "42.3%" },
      { name: "HomeTech Department", link: "https://kuula.co/share/hymQk/collection/7Hhr1?logo=-1&info=0&fs=0&vr=0&sd=1&thumbs=-1&keys=0", top: "38%", left: "23.5%" },
      { name: "Bamboo Textile Fiber Innovation Hub", link: "https://kuula.co/share/hRnJd/collection/7H5Mg?logo=-1&info=0&fs=0&vr=0&sd=1&thumbs=-1&keys=0", top: "78%", left: "33%" },
      { name: "Main Gate", link: "https://kuula.co/share/hR8LG/collection/7H5CQ?logo=-1&info=0&fs=0&vr=0&sd=1&thumbs=-1&keys=0", top: "37.5%", left: "21.2%" }
    ];

    // Tour assets mapping (same as in tour.html)
    const tourAssets = {
      "7HLDj": { left: "assets/logos/logo.png", right: "assets/maps/admin.png" },
      "7H4DT": { left: "assets/logos/logo.png", right: "assets/maps/labschool.png" },
      "7Hm8L": { left: "assets/logos/logo.png", right: "assets/maps/elem.png" },
      "7Hhr1": { left: "assets/logos/logo.png", right: "assets/maps/ht.png" },
      "7HL6Z": { left: "assets/logos/logo.png", right: "assets/maps/ffp.png" },
      "7Hm6F": { left: "assets/logos/logo.png", right: "assets/maps/research.png" },
      "7HmCC": { left: "assets/logos/logo.png", right: "assets/maps/aftic.png" },
      "7HmPt": { left: "assets/logos/logo.png", right: "assets/maps/heas.png" },
      "7Hmlp": { left: "assets/logos/logo.png", right: "assets/maps/clinic.png" },
      "7DSYF": { left: "assets/logos/logo.png", right: "assets/maps/library.png" },
      "7H4MG": { left: "assets/logos/logo.png", right: "assets/maps/gym.png" },
      "7H5Mg": { left: "assets/logos/logo.png", right: "assets/maps/bamboo.png" },
      "7D308": { left: "assets/logos/logo.png", right: "assets/maps/cmcs.png" },
      "7Dtgc": { left: "assets/logos/logo.png", right: "assets/maps/sciences.png" },
      "7H4Mc": { left: "assets/logos/logo.png", right: "assets/maps/guidance.png" },
      "7H4qw": { left: "assets/logos/logo.png", right: "assets/maps/natsci.png" },
      "7DWfD": { left: "assets/logos/logo.png", right: "assets/maps/sc.png" },
      "7DxGN": { left: "assets/logos/logo.png", right: "assets/maps/educ.png" },
      "7D3R5": { left: "assets/logos/logo.png", right: "assets/maps/forestry.png" },
      "7DrsL": { left: "assets/logos/logo.png", right: "assets/maps/new-agri.png" },
      "7DSkq": { left: "assets/logos/logo.png", right: "assets/maps/atdc.png" },
      "7HLvX": { left: "assets/logos/logo.png", right: "assets/maps/processing.png" },
      "7H4HH": { left: "assets/logos/logo.png", right: "assets/maps/old-agri.png" },
      "7DSqc": { left: "assets/logos/logo.png", right: "assets/maps/exe.png" },
      "7DSkB": { left: "assets/logos/logo.png", right: "assets/maps/guest.png" },
      "7H5CQ": { left: "assets/logos/logo.png", right: "assets/maps/main.png" }
    };

    const container = document.getElementById('mapContainer');
    const viewer = document.getElementById('viewer');
    const frame = document.getElementById('tourFrame');
    const backBtn = document.getElementById('backBtn');
    const sidebar = document.getElementById('sidebar');
    const menuBtn = document.getElementById('menuBtn');
    const overlay = document.getElementById('overlay');
    const leftLogo = document.getElementById('leftLogo');
    const rightLogo = document.getElementById('rightLogo');

    // Create map pins
    pins.forEach(p => {
      const el = document.createElement('div');
      el.className = 'pin';
      el.style.top = p.top;
      el.style.left = p.left;
      el.title = p.name;

      const tip = document.createElement('div');
      tip.className = 'tooltip';
      tip.innerText = p.name;
      el.appendChild(tip);

      el.addEventListener('click', ev => {
        ev.stopPropagation();
        openTour(p.link);
      });
      container.appendChild(el);
    });

    // Listen for messages from sidebar (tours.html)
    window.addEventListener('message', function (event) {
      if (event.data && event.data.type === 'openTour') {
        openTour(event.data.url);
      }
    });

    function updateOverlayImages(tourUrl) {
      // Extract tour code from Kuula URL
      const match = tourUrl.match(/collection\/([a-zA-Z0-9]+)/);
      const tourCode = match ? match[1] : null;

      // Update logo + map dynamically
      if (tourCode && tourAssets[tourCode]) {
        leftLogo.src = tourAssets[tourCode].left;
        rightLogo.src = tourAssets[tourCode].right;
      } else {
        // Fallback to default images
        leftLogo.src = "assets/logos/logo.png";
        rightLogo.src = "assets/maps/default.png";
      }
    }

    function openTour(url) {
      frame.src = url;
      updateOverlayImages(url);
      viewer.classList.add('open');
      viewer.setAttribute('aria-hidden', 'false');
      setTimeout(() => backBtn.classList.add('show'), 220);
      document.querySelector('.map-container').style.filter = 'blur(1px) brightness(.9)';
      closeSidebar();

      // Request fullscreen on the viewer
      setTimeout(() => {
        if (viewer.requestFullscreen) {
          viewer.requestFullscreen().catch(err => {
            console.log('Fullscreen request failed:', err);
          });
        }
      }, 300);
    }

    function closeTour() {
      // Exit fullscreen if active
      if (document.fullscreenElement) {
        document.exitFullscreen();
      }

      backBtn.classList.remove('show');
      viewer.classList.remove('open');
      viewer.setAttribute('aria-hidden', 'true');
      setTimeout(() => { 
        frame.src = "";
        // Reset to default images
        leftLogo.src = "assets/logos/logo.png";
        rightLogo.src = "assets/maps/default.png";
      }, 420);
      document.querySelector('.map-container').style.filter = 'none';
    }

    backBtn.addEventListener('click', closeTour);
    viewer.addEventListener('click', e => {
      if (e.target === viewer) closeTour();
    });

    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') {
        closeTour();
        closeSidebar();
      }
    });

    // Handle fullscreen change events
    document.addEventListener('fullscreenchange', () => {
      if (!document.fullscreenElement) {
        // User exited fullscreen, close the tour
        if (viewer.classList.contains('open')) {
          closeTour();
        }
      }
    });

    function openSidebar() {
      sidebar.classList.add('open');
      overlay.classList.add('show');
    }

    function closeSidebar() {
      sidebar.classList.remove('open');
      overlay.classList.remove('show');
    }

    menuBtn.addEventListener('click', openSidebar);
    overlay.addEventListener('click', closeSidebar);
  </script>
</body>

</html>